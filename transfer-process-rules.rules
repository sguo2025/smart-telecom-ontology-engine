# ==============================================================================
# CRM过户业务流程推理规则
# ==============================================================================
# 目标：从最小输入（TransferProcess实例 + 原客户 + 目标客户）
#       自动推理出完整的4个流程步骤及其关联关系
# ==============================================================================

# 命名空间定义
@prefix crm: <http://example.com/crm/transfer#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .

# ==============================================================================
# Rule 1: Auto-infer all 4 required process steps
# ==============================================================================

[Rule_AddCustomerLocation:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#CustomerLocation>)
]

[Rule_AddTargetCustomerVerification:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#TargetCustomerVerification>)
]

[Rule_AddElectronicSignature:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#ElectronicSignature>)
]

[Rule_AddOrderSummaryDisplay:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#OrderSummaryDisplay>)
]

# ==============================================================================
# Rule 2: Infer verification method based on customer info
# ==============================================================================

[Rule_InferIDCardVerification:
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?customer),
    (?customer <http://example.com/crm/transfer#hasIDCardNumber> ?idcard),
    notEqual(?idcard, "")
    ->
    (?process <http://example.com/crm/transfer#usesVerificationMethod> <http://example.com/crm/transfer#IDCardVerification>)
]

[Rule_InferSMSVerification:
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?customer),
    (?customer <http://example.com/crm/transfer#hasBusinessNumber> ?phone),
    notEqual(?phone, ""),
    noValue(?customer <http://example.com/crm/transfer#hasIDCardNumber>)
    ->
    (?process <http://example.com/crm/transfer#usesVerificationMethod> <http://example.com/crm/transfer#SMSVerification>)
]

# ==============================================================================
# Rule 3: Auto-apply business rule constraints
# ==============================================================================

[Rule_ApplyArrearsRule:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#isConstrainedBy> <http://example.com/crm/transfer#ArrearsRule>)
]

[Rule_ApplyPendingOrderRule:
    (?process rdf:type <http://example.com/crm/transfer#TransferProcess>)
    ->
    (?process <http://example.com/crm/transfer#isConstrainedBy> <http://example.com/crm/transfer#PendingOrderRule>)
]

# ==============================================================================
# Rule 4: Business rule violation detection
# ==============================================================================

[Rule_DetectArrearsViolation:
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?customer),
    (?customer <http://example.com/crm/transfer#hasArrearsStatus> true)
    ->
    (?process <http://example.com/crm/transfer#violatesRule> <http://example.com/crm/transfer#ArrearsRule>)
]

[Rule_DetectPendingOrderViolation:
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?customer),
    (?customer <http://example.com/crm/transfer#hasPendingOrderStatus> true)
    ->
    (?process <http://example.com/crm/transfer#violatesRule> <http://example.com/crm/transfer#PendingOrderRule>)
]

# ==============================================================================
# Rule 5: Transitive step order inference
# ==============================================================================

[Rule_TransitiveStepOrder:
    (?stepA <http://example.com/crm/transfer#hasPredecessorStep> ?stepB),
    (?stepB <http://example.com/crm/transfer#hasPredecessorStep> ?stepC)
    ->
    (?stepA <http://example.com/crm/transfer#hasPredecessorStep> ?stepC)
]

# ==============================================================================
# Rule 6: Order-customer relationship inference
# ==============================================================================

[Rule_LinkOrderToCustomers:
    (?process <http://example.com/crm/transfer#generatesTransferOrder> ?order),
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?origCustomer),
    (?process <http://example.com/crm/transfer#relatesTargetCustomer> ?targetCustomer)
    ->
    (?order <http://example.com/crm/transfer#includesOriginalCustomer> ?origCustomer),
    (?order <http://example.com/crm/transfer#includesTargetCustomer> ?targetCustomer)
]

# ==============================================================================
# Rule 7: Process completeness validation
# ==============================================================================

[Rule_ProcessIsComplete:
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#CustomerLocation>),
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#TargetCustomerVerification>),
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#ElectronicSignature>),
    (?process <http://example.com/crm/transfer#hasProcessStep> <http://example.com/crm/transfer#OrderSummaryDisplay>),
    (?process <http://example.com/crm/transfer#relatesOriginalCustomer> ?origCustomer),
    (?process <http://example.com/crm/transfer#relatesTargetCustomer> ?targetCustomer)
    ->
    (?process <http://example.com/crm/transfer#isCompleteProcess> true)
]
